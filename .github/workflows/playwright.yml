name: Playwright Tests
on:
  push:
    branches: [ qa, production ]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Choose functionality to test'
        default: "@prodSanity"
        type: choice
        required: false
        options:
          - "kyc"
          - "trading"
          - "signIn"
          - "withdrawal"
          - "verification"
          - "deposit"
          - "manageFunds"
          - "feed"
          - "settings"
          - "support"
          - "secondAccount"
          - "prodSanity"
          - "website-naga.com"
          - "debug"
      ticket_id:
        description: 'Jira ticket ID (e.g. RG-1234)'
        type: string
  schedule:
    - cron: '30 4 * * 0-6'
    - cron: '40 5 * * 0-6'
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    outputs:
      deployment_url: ${{ steps.extract_url.outputs.deployment_url }}
    steps:
    - name: Output Received values
      run: |
        echo "${{ inputs.ticket_id }} | ${{ inputs.tag }}"
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 20
        cache: 'npm'
        cache-dependency-path: package-lock.json
    - uses: actions/cache@v3
      id: playwright-cache
      with:
          path: '~/.cache/ms-playwright'
          key: '${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}'
          restore-keys: |
            ${{ runner.os }}-playwright-
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    - name: 'Create env file'
      run: |
          touch .env
          echo TESTRAIL_USERNAME=${{ secrets.TESTRAIL_USERNAME }} >> .env
          echo TESTRAIL_PASSWORD=${{ secrets.TESTRAIL_PASSWORD }} >> .env
          echo USER_PASSWORD=${{ secrets.USER_PASSWORD }} >> .env
          echo NORDVPN_USERNAME=${{ secrets.NORDVPN_USERNAME }} >> .env
          echo NORDVPN_PASSWORD=${{ secrets.NORDVPN_PASSWORD }} >> .env
          cat .env 
    - name: Determine tags
      id: determine_tags
      run: |
              echo "Schedule: ${{ github.event.schedule }}"
              case "${{ github.event.schedule }}" in
                "30 4 * * 0-6") echo "TAGS=@prodSanity" >> $GITHUB_ENV ;;
                "40 5 * * 0-6") echo "TAGS=@website-naga.com" >> $GITHUB_ENV ;;
              esac
    - name: Run Playwright tests
      id: playwright_tests
      run: |
          ENV=${{ github.head_ref || github.ref_name }}
          if [ -z "$TAGS" ]; then
          TAGS=@${{ inputs.tag }}
          fi
          if [ "$ENV" = "production" ]; then
            echo "Running $ENV tests for $TAGS"
            ENV="$ENV" TAGS="$TAGS" npx playwright test --grep "$TAGS" --project=${{ github.head_ref || github.ref_name }} --workers=1;
          elif [ "$GITHUB_EVENT_NAME" == "schedule" ]; then
            echo "Running $ENV tests with tag $TAGS"
            ENV="$ENV" TAGS="$TAGS" npx playwright test --grep "$TAGS" --project=${{ github.head_ref || github.ref_name }} --workers=1;
          else 
            echo "Running all tests"
            ENV="$ENV" TAGS="$TAGS" npx playwright test --grep "$TAGS" --project=${{ github.head_ref || github.ref_name }} --workers=1;
          fi
    - uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
    - name: Publish to Cloudflare Pages
      if: always()
      id: cloudflare_publish
      uses: cloudflare/pages-action@v1
      env:
        CLOUDFLARE_API_TKN: ${{ secrets.CLOUDFLARE_API_TKN }}
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TKN }}
        accountId: ${{ vars.CLOUDFLARE_ACCOUNT_ID_KWG }}
        projectName: playwright-naga-report-${{ github.head_ref || github.ref_name }}
        directory: playwright-report
        branch: master
    - name: Extract deployment URL
      if: always()
      id: extract_url
      run: |
        URL=$(echo "${{ join(steps.cloudflare_publish.outputs.*, ' ') }}" | grep -o 'https://[^ ]*' | head -n 1)
        echo "deployment_url=$URL" >> $GITHUB_ENV    
    - name: Use the URL
      if: always()
      run: |
          echo "The deployment URL is $deployment_url"
    - name: Set outcome title
      if: always()
      id: set_outcome_title
      run: |
        if [ "${{ steps.playwright_tests.outcome }}" == "success" ]; then
          echo "::set-output name=title::✅ Naga Test Passed on "
        else
          echo "::set-output name=title::❌ Naga Test Failed on "
        fi
    - name: Notify test result for dedicated teams channel
      if: always()
      uses: neonidian/teams-notify-build-status@v3
      with:
        webhookUrl: ${{ secrets.TEAMS_WEBHOOK_URL  }}   
        status: ${{ steps.playwright_tests.outcome }}  
        title: ${{ steps.set_outcome_title.outputs.title }} ${{ github.head_ref || github.ref_name }} ${{ inputs.tag }} ${{ env.TAGS }}
        message: >-
            View report [${{ env.deployment_url }}](${{ env.deployment_url }})
      env:
        SHOULD_DISPLAY_VIEW_RUN_BUTTON: true
        SHOULD_DISPLAY_VIEW_COMMIT_BUTTON: true
        SHOULD_DISPLAY_ACTOR_LABEL: true
     # when trigger_type equal "jira", send a webhook request to an API and send to it the ticket_id, env.deployment_url, steps.playwright_tests.outcome, steps.set_outcome_title.outputs.title, inputs.tag
    - name: Notify test result for Jira
      if: always()
      run: |
        if [ "${{ inputs.ticket_id }}" != "" ]; then
          curl -X POST -H "Content-Type: application/json" -d '{"issues": ["${{ inputs.ticket_id }}"], "deployment_url": "${{ env.deployment_url }}", "outcome": "${{ steps.playwright_tests.outcome }}", "title": "${{ steps.set_outcome_title.outputs.title }}", "tag": "${{ inputs.tag }}"}' https://automation.atlassian.com/pro/hooks/4b467d276516ee000032b4a318650c41ec54fa0c
        fi
